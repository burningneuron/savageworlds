/**
 *
 * Backbone-DocumentModel v0.6.4
 *
 * Copyright (c) 2013 Michael Haselton & Aaron Herres, Loqwai LLC
 *
 * https://github.com/icereval/backbone-documentmodel
 * Licensed under the MIT License
 */

(function(e){typeof define=="function"&&define.amd?define(["underscore","backbone"],e):typeof exports!="undefined"?module.exports=e(require("underscore"),require("backbone")):e(_,Backbone)})(function(e,t){function n(e,n,r){return new t.DocumentModel(n,r)}function r(e,n,r){return new t.DocumentCollection(n,r)}function i(e){return this.pseudoIdAttribute?this.findWhere({value:e}):t.Collection.prototype.get.call(this,e)}function s(n){if(!e.isString(n))return t.Model.prototype.get.call(this,n);var r=e.isArray(n)?n:n.split("."),i=t.Model.prototype.get.call(this,r.shift());return i===undefined?undefined:(e.each(r,function(t){var n;i!==undefined&&(n=parseInt(t,10),i=e.isFinite(n)?i.at(n):i.get(t),i!==undefined&&i.collection&&i.collection.pseudoIdAttribute&&(i=i.get("value")))},this),i)}function o(e,n){return n||(n={}),delete n.name,delete n.parent,t.Collection.prototype.set.call(this,e,n)}function u(n,r){e.extend(r,e.pick(this.idAttribute?this:e.isObject(n)?n:this,["idAttribute"]));if(Object.prototype.toString.call(n)!=="[object Object]"||e.isArray(n)){var i=n;this.pseudoIdAttribute=!0,n={},n[r.idAttribute]=e.uniqueId(),n.value=i}return t.Collection.prototype._prepareModel.call(this,n,r)}function a(n,r,i){var s,o,u={},a={};return n==null?this:(typeof n=="object"?(s=n,i=r):(s={})[n]=r,i||(i={}),o=s instanceof t.Collection||s instanceof t.Model,o||e.each(e.keys(s),function(t){if(t.indexOf(".")>0)a[t]=s[t],delete s[t];else if(Object.prototype.toString.call(s[t])==="[object Object]"||e.isArray(s[t]))u[t]=s[t],delete s[t]}),t.Model.prototype.set.call(this,s,i)?(o||(e.each(e.keys(a),function(t){var n=t.split("."),r=n.pop(),s=!1,o=u;for(var f=0;f<n.length;f++){var l=n[f],c=n[f+1];if(e.isFinite(c)){var h=e.reduce(n,function(e,t){return e+"."+t}),p=this.get.call(this,h);p&&p.set(r,a[t],i),s=!0;break}o[l]||(o[l]={}),o=o[l]}s||(o[r]=a[t])},this),e.each(e.keys(u),function(n){var r,s=u[n];this.attributes[n]?this.attributes[n].set.call(this.attributes[n],s,i):(r={parent:this},e.extend(r,e.pick(this,["idAttribute"])),r.name=n,e.isArray(s)?t.Model.prototype.set.call(this,n,this.getNestedCollection(n,s,r),i):this instanceof t.DocumentModel&&(s instanceof t.DocumentModel?(s.get(this.idAttribute)||(s.set(this.idAttribute,this.get(this.idAttribute),{silent:!0}),r.pseudoIdAttribute=!0),e.extend(s,r),t.Model.prototype.set.call(this,n,s,i)):s[this.idAttribute]||(s[this.idAttribute]=this.get(this.idAttribute),r.pseudoIdAttribute=!0,t.Model.prototype.set.call(this,n,this.getNestedModel(n,s,r),i))))},this)),this):!1)}function f(){var n=[],r;if(this instanceof t.Collection){var i=this.models;r=[],e.each(e.keys(i),function(e){var t=i[e].toJSON();this.pseudoIdAttribute&&(t=t.value),r.push(t)},this)}else if(this instanceof t.Model&&this.attributes){var s=this.attributes;r={},this.collection&&this.collection.pseudoIdAttribute?r=this.get("value"):(e.each(e.keys(s),function(e){(s[e]instanceof t.Model||s[e]instanceof t.Collection)&&n.push(e)}),this.pseudoIdAttribute&&delete s[this.idAttribute],r=e.omit(s,n),e.each(n,function(e){r[e]=s[e].toJSON()}))}return r}function l(t){var n=t.split(":"),r=n[0],i=n.length>1?e.last(n,n.length-1)[0].split("."):[],s=Array.prototype.slice.call(arguments,0);if(t==="change")return;i.unshift(this.name);var o=e.reduce(i,function(e,t){return e+"."+t});s[0]=r+":"+o,this.parent.trigger.apply(this.parent,s)}function c(n){t.Events.trigger.apply(this,arguments);if(this._events){var r=e.filter(e.keys(this._events),function(e){var t=!1;return n!==e&&(n.substring(0,6)==="change"?n.indexOf(".")>=0&&(t=!0):t=!0),t&&e.indexOf(":")>=0&&n.indexOf(":")>=0&&n.match(e)});if(r.length){var i=Array.prototype.slice.call(arguments,0);e.each(r,function(e){i[0]=e,t.Events.trigger.apply(this,i)},this)}}}function h(e,n,r){var i=this;while(i.parent||i.collection&&i.collection.parent)i=i.parent||i.collection.parent;return t.Model.prototype.save.call(i,e,n,r)}function p(){return new this.constructor(this.toJSON())}var d=t.Model.extend({constructor:function(n,r){r||(r={}),e.extend(this,e.pick(r,["idAttribute","parent","name","pseudoIdAttribute","getNestedModel","getNestedCollection"])),t.Model.apply(this,arguments),this.on("all",function(){this.parent&&this.name&&l.apply(this,arguments)},this)},pseudoIdAttribute:!1,toJSON:f,get:s,set:a,save:h,clone:p,trigger:c,getNestedModel:n,getNestedCollection:r}),v=t.Collection.extend({constructor:function(n,r){r||(r={}),e.extend(this,e.pick(r,["idAttribute","parent","name"])),t.Collection.apply(this,arguments),this.on("all",function(){this.parent&&this.name&&l.apply(this,arguments)},this)},pseudoIdAttribute:!1,model:d,toJSON:f,get:i,set:o,clone:p,trigger:c,_prepareModel:u});return t.DocumentModel=d,t.DocumentCollection=v,typeof module!="undefined"&&(module.exports=d),t});