// the tagRangeFinder function is
//   Copyright (C) 2011 by Daniel Glazman <daniel@glazman.org>
// released under the MIT license (../../LICENSE) like the rest of CodeMirror

CodeMirror.tagRangeFinder=function(e,t){var n="A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",r=n+"-:.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040",i=new RegExp("^["+n+"]["+r+"]*"),s=e.getLine(t.line),o=!1,u=null,a=t.ch;while(!o){a=s.indexOf("<",a);if(-1==a)return;if(a+1<s.length&&s[a+1]=="/"){a++;continue}if(!s.substr(a+1).match(i)){a++;continue}var f=s.indexOf(">",a+1);if(-1==f){var l=t.line+1,c=!1,h=e.lineCount();while(l<h&&!c){var p=e.getLine(l);f=p.indexOf(">");if(-1!=f){c=!0;var d=p.lastIndexOf("/",f);if(-1!=d&&d<f){var v=s.substr(d,f-d+1);if(!v.match(/\/\s*\>/))return}}l++}o=!0}else{var m=s.lastIndexOf("/",f);if(-1==m)o=!0;else{var v=s.substr(m,f-m+1);v.match(/\/\s*\>/)||(o=!0)}}if(o){var g=s.substr(a+1);u=g.match(i),u?(u=u[0],-1!=s.indexOf("</"+u+">",a)&&(o=!1)):o=!1}o||a++}if(o){var y="(\\<\\/"+u+"\\>)|(\\<"+u+"\\>)|(\\<"+u+"\\s)|(\\<"+u+"$)",b=new RegExp(y),w="</"+u+">",E=1,l=t.line+1,h=e.lineCount();while(l<h){s=e.getLine(l);var S=s.match(b);if(S)for(var x=0;x<S.length;x++){S[x]==w?E--:E++;if(!E)return{from:{line:t.line,ch:f+1},to:{line:l,ch:S.index}}}l++}return}},CodeMirror.braceRangeFinder=function(e,t){var n=t.line,r=e.getLine(n),i=r.length,s,o;for(;;){var u=r.lastIndexOf("{",i);if(u<t.ch)break;o=e.getTokenAt({line:n,ch:u}).type;if(!/^(comment|string)/.test(o)){s=u;break}i=u-1}if(s==null||r.lastIndexOf("}")>s)return;var a=1,f=e.lineCount(),l,c;e:for(var h=n+1;h<f;++h){var p=e.getLine(h),d=0;for(;;){var v=p.indexOf("{",d),m=p.indexOf("}",d);v<0&&(v=p.length),m<0&&(m=p.length),d=Math.min(v,m);if(d==p.length)break;if(e.getTokenAt({line:h,ch:d+1}).type==o)if(d==v)++a;else if(!--a){l=h,c=d;break e}++d}}if(l==null||l==n+1)return;return{from:{line:n,ch:s+1},to:{line:l,ch:c}}},CodeMirror.indentRangeFinder=function(e,t){var n=e.getOption("tabSize"),r=e.getLine(t.line),i=CodeMirror.countColumn(r,null,n);for(var s=t.line+1,o=e.lineCount();s<o;++s){var u=e.getLine(s);if(CodeMirror.countColumn(u,null,n)<i)return{from:{line:t.line,ch:r.length},to:{line:s,ch:u.length}}}},CodeMirror.newFoldFunction=function(e,t){t==null&&(t="â†”");if(typeof t=="string"){var n=document.createTextNode(t);t=document.createElement("span"),t.appendChild(n),t.className="CodeMirror-foldmarker"}return function(n,r){typeof r=="number"&&(r={line:r,ch:0});var i=e(n,r);if(!i)return;var s=n.findMarksAt(i.from),o=0;for(var u=0;u<s.length;++u)s[u].__isFold&&(++o,s[u].clear());if(o)return;var a=t.cloneNode(!0);CodeMirror.on(a,"mousedown",function(){f.clear()});var f=n.markText(i.from,i.to,{replacedWith:a,clearOnEnter:!0,__isFold:!0})}};